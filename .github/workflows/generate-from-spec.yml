name: Generate SDK from OpenAPI Spec

on:
  repository_dispatch:
    types: [spec-updated]

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      before_sha:
        description: 'Before commit SHA (leave empty for HEAD~1)'
        required: false
      after_sha:
        description: 'After commit SHA (leave empty for HEAD)'
        required: false

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Python SDK
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set commit SHAs
        id: shas
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "before_sha=${{ github.event.client_payload.before_sha }}" >> $GITHUB_OUTPUT
            echo "after_sha=${{ github.event.client_payload.after_sha }}" >> $GITHUB_OUTPUT
            echo "source_repo=${{ github.event.client_payload.source_repo }}" >> $GITHUB_OUTPUT
            echo "commit_message=${{ github.event.client_payload.commit_message }}" >> $GITHUB_OUTPUT
          else
            # Manual trigger - use inputs or defaults
            SOURCE_REPO="${{ github.repository_owner }}/videodb-sdk-orchestrator"
            echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
            echo "commit_message=Manual trigger" >> $GITHUB_OUTPUT

            if [[ -n "${{ inputs.before_sha }}" ]]; then
              echo "before_sha=${{ inputs.before_sha }}" >> $GITHUB_OUTPUT
            else
              echo "before_sha=" >> $GITHUB_OUTPUT
            fi

            if [[ -n "${{ inputs.after_sha }}" ]]; then
              echo "after_sha=${{ inputs.after_sha }}" >> $GITHUB_OUTPUT
            else
              echo "after_sha=main" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Fetch OpenAPI spec diff
        id: diff
        env:
          GH_TOKEN: ${{ secrets.SDK_SYNC_PAT }}
        run: |
          SOURCE_REPO="${{ steps.shas.outputs.source_repo }}"
          BEFORE_SHA="${{ steps.shas.outputs.before_sha }}"
          AFTER_SHA="${{ steps.shas.outputs.after_sha }}"

          echo "Fetching diff from $SOURCE_REPO"
          echo "Before: $BEFORE_SHA"
          echo "After: $AFTER_SHA"

          # Fetch the diff
          if [[ -n "$BEFORE_SHA" ]]; then
            gh api \
              -H "Accept: application/vnd.github.v3.diff" \
              "/repos/$SOURCE_REPO/compare/${BEFORE_SHA}...${AFTER_SHA}" \
              > spec.diff 2>/dev/null || echo "Could not fetch diff"
          else
            echo "No before SHA, fetching full spec only"
            touch spec.diff
          fi

          # Fetch the current spec file
          gh api \
            -H "Accept: application/vnd.github.raw" \
            "/repos/$SOURCE_REPO/contents/openapi.yaml?ref=${AFTER_SHA}" \
            > spec_current.yaml

          # Show diff size for logging
          echo "Diff size: $(wc -l < spec.diff) lines"

      - name: Run Codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          model: o4-mini
          sandbox: workspace-write
          prompt: |
            You are updating the VideoDB Python SDK based on OpenAPI spec changes.

            ## Git Diff of OpenAPI Spec Changes

            The following diff shows what changed in the API specification:

            ```diff
            $(cat spec.diff)
            ```

            ## Current OpenAPI Spec

            If you need to reference the full spec for context, it's available at: spec_current.yaml

            ## Your Task

            1. First, read the existing SDK structure in the `videodb/` directory to understand:
               - How the client is structured (`videodb/_utils/_http_client.py` or similar)
               - How models/types are defined
               - Existing patterns for API methods

            2. Based on the diff, implement the necessary SDK changes:
               - New endpoints = new methods
               - Modified endpoints = updated methods
               - New request/response schemas = new classes/types

            3. Follow the existing code patterns exactly. Match:
               - Import style
               - Method signatures
               - Error handling patterns
               - Docstring format

            ## Important

            - Do NOT modify `__about__.py`, `__init__.py`, or version numbers
            - Do NOT add type hints if the existing code doesn't use them consistently
            - Do NOT refactor unrelated code
            - Only implement what the diff indicates was added/changed

      - name: Check for changes and create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes generated by Codex"
            exit 0
          fi

          # Clean up temporary files - DO NOT commit these
          rm -f spec.diff spec_current.yaml

          # Create branch
          BRANCH="auto/spec-sync-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"
          git add -A

          # Commit
          COMMIT_MSG="${{ steps.shas.outputs.commit_message }}"
          git commit -m "feat: sync with OpenAPI spec changes

          Source: ${{ steps.shas.outputs.source_repo }}@${{ steps.shas.outputs.after_sha }}
          Original commit: ${COMMIT_MSG}

          Generated by OpenAI Codex"

          # Push
          git push origin "$BRANCH"

          # Create PR
          gh pr create \
            --title "feat: sync with OpenAPI spec" \
            --body "## Summary

          Automated SDK update based on OpenAPI spec changes.

          **Source**: \`${{ steps.shas.outputs.source_repo }}\`
          **Commit**: \`${{ steps.shas.outputs.after_sha }}\`
          **Original message**: ${{ steps.shas.outputs.commit_message }}

          ## Changes

          This PR was automatically generated by Codex based on the following spec diff:

          <details>
          <summary>OpenAPI Spec Diff</summary>

          \`\`\`diff
          $(head -200 spec.diff)
          \`\`\`

          </details>

          ## Review Checklist

          - [ ] Generated code follows SDK conventions
          - [ ] Method signatures are correct
          - [ ] No breaking changes introduced
          - [ ] Tests pass locally

          ---
          *Generated by [OpenAI Codex](https://github.com/openai/codex)*"
