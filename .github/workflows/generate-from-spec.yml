name: Generate SDK from OpenAPI Spec

on:
  repository_dispatch:
    types: [spec-updated]

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      spec_b64:
        description: 'Base64-encoded OpenAPI spec'
        required: true
      diff_b64:
        description: 'Base64-encoded diff (optional)'
        required: false

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Python SDK
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Extract spec and diff from payload
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            SPEC_B64="${{ github.event.client_payload.spec_b64 }}"
            DIFF_B64="${{ github.event.client_payload.diff_b64 }}"
          else
            SPEC_B64="${{ inputs.spec_b64 }}"
            DIFF_B64="${{ inputs.diff_b64 }}"
          fi

          # Decode and save spec
          echo "$SPEC_B64" | base64 -d > spec_current.yaml
          echo "Spec size: $(wc -l < spec_current.yaml) lines"

          # Decode and save diff
          if [[ -n "$DIFF_B64" ]]; then
            echo "$DIFF_B64" | base64 -d > spec.diff
          else
            touch spec.diff
          fi
          echo "Diff size: $(wc -l < spec.diff) lines"

      - name: Run Codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          model: o4-mini
          sandbox: workspace-write
          prompt: |
            You are updating the VideoDB Python SDK based on OpenAPI spec changes.

            ## Git Diff of OpenAPI Spec Changes

            The following diff shows what changed in the API specification:

            ```diff
            $(cat spec.diff)
            ```

            ## Current OpenAPI Spec

            If you need to reference the full spec for context, it's available at: spec_current.yaml

            ## Your Task

            1. First, read the existing SDK structure in the `videodb/` directory to understand:
               - How the client is structured (`videodb/_utils/_http_client.py` or similar)
               - How models/types are defined
               - Existing patterns for API methods

            2. Based on the diff, implement the necessary SDK changes:
               - New endpoints = new methods
               - Modified endpoints = updated methods
               - New request/response schemas = new classes/types

            3. Follow the existing code patterns exactly. Match:
               - Import style
               - Method signatures
               - Error handling patterns
               - Docstring format

            ## Important

            - Do NOT modify `__about__.py`, `__init__.py`, or version numbers
            - Do NOT add type hints if the existing code doesn't use them consistently
            - Do NOT refactor unrelated code
            - Only implement what the diff indicates was added/changed

      - name: Check for changes and create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes generated by Codex"
            exit 0
          fi

          # Clean up temporary files - DO NOT commit these
          rm -f spec.diff spec_current.yaml

          # Create branch
          BRANCH="auto/spec-sync-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"
          git add -A

          # Commit
          git commit -m "feat: sync with OpenAPI spec changes

          Generated by OpenAI Codex"

          # Push
          git push origin "$BRANCH"

          # Create PR
          gh pr create \
            --title "feat: sync with OpenAPI spec" \
            --body "## Summary

          Automated SDK update based on OpenAPI spec changes.

          ## Review Checklist

          - [ ] Generated code follows SDK conventions
          - [ ] Method signatures are correct
          - [ ] No breaking changes introduced
          - [ ] Tests pass locally

          ---
          *Generated by [OpenAI Codex](https://github.com/openai/codex)*"
